services:

  # ======= MICROSERVICES =======
  api-gateway:
    image: socialbeats/api-gateway:latest
    container_name: api-gateway
    ports:
      - "3000:3000"
    env_file:
      - ./.env
    environment:
      - NODE_ENV=development
      - PORT=3000
      - LOG_LEVEL=silly
      - JWT_SECRET=secret
      - ALLOWED_ORIGINS=*
      - REDIS_URL=redis://api-gateway-redis:6379
      - USERS_SERVICE_URL=http://users-service:3001
      - BEATS_INTERACTION_SERVICE_URL=http://beats-interaction-service:3002
      - ANALYTICS_SERVICE_URL=http://analytics-service:3003
      - SOCIAL_SERVICE_URL=http://social-service:3004
      - BEATS_SERVICE_URL=http://beats-service:3005
      - PAYMENTS_SERVICE_URL=http://payments-and-suscription:3006
      - NOTIFICATIONS_SERVICE_URL=http://notifications-service:3007
      - FREE_PLAN_MAX_REQUESTS_PER_MINUTE=1000
      - BASIC_PLAN_MAX_REQUESTS_PER_MINUTE=5000
      - PREMIUM_PLAN_MAX_REQUESTS_PER_MINUTE=20000
      - ENTERPRISE_PLAN_MAX_REQUESTS_PER_MINUTE=100000
      - SPACE_URL=http://space-nginx:5403
    depends_on:
      api-gateway-redis:
        condition: service_healthy
    networks:
      - socialbeats-network
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "require('http').get('http://localhost:3000/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  users-service:
    image: socialbeats/user-auth:latest
    container_name: users-service
    env_file:
      - ./.env
    environment:
      - MONGOADMIN=
      - MONGOPASS=
      - MONGOURL=mongodb://user-auth-mongodb:27017/user-auth
      - MONGOTESTURL=mongodb://user-auth-mongodb:27017/user-auth_test
      - NODE_ENV=development
      - PORT=3001
      - LOG_LEVEL=silly
      - JWT_SECRET=secret
      - JWT_ACCESS_EXPIRY=15m
      - JWT_REFRESH_EXPIRY=7
      - REDIS_HOST=user-auth-redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=
      - API_TITLE="Users and Authentication Microservice"
      - API_DESCRIPTION="This is an OAS description of this Microservice REST API"
      - DEFAULT_ADMIN_USERNAME=admin
      - DEFAULT_ADMIN_EMAIL=admin@example.com
      - DEFAULT_ADMIN_PASSWORD=admin1234
      - ENABLE_KAFKA=true
      - KAFKA_BROKER=kafka:9092
      - KAFKA_CONNECTION_MAX_RETRIES=10
      - KAFKA_CONNECTION_RETRY_DELAY=3000
      - KAFKA_COOLDOWN=30000
      - PAYMENTS_SERVICE_URL=http://payments-and-suscription:3006/api/v1/payments
    depends_on:
      - user-auth-mongodb
      - user-auth-redis
      - kafka
    networks:
      - socialbeats-network
    ports:
      - "3001:3001"

  beats-interaction-service:
    image: socialbeats/beats-interaction:latest
    container_name: beats-interaction-service
    env_file:
      - ./.env
    environment:
      - MONGOADMIN=
      - MONGOPASS=
      - MONGOURL=mongodb://beats-interaction-mongodb:27017/beats-interaction
      - MONGOTESTURL=mongodb://beats-interaction-mongodb:27017/beats-interaction_test
      - NODE_ENV=development
      - JWT_SECRET=secret
      - PORT=3002
      - LOG_LEVEL=silly
      - API_TITLE="beats-interaction microservice API"
      - API_DESCRIPTION="This is an OAS description of this beats-interaction microservice REST API"
      - KAFKA_CONNECTION_MAX_RETRIES=10
      - KAFKA_CONNECTION_RETRY_DELAY=3000
      - KAFKA_COOLDOWN=30000
      - KAFKA_BROKER=kafka:9092
      - ENABLE_KAFKA=true
      - ENABLE_REDIS=false
      - REDIS_HOST=beats-interaction-redis
      - REDIS_PORT=6379
      - REDIS_CONNECTION_MAX_RETRIES=5
      - REDIS_CONNECTION_RETRY_DELAY=2000
      - REDIS_COOLDOWN=30000
      - AUTH_SERVICE_URL=http://users-service:3001/api/v1/auth/internal/user/
      - SPACE_URL=http://space-nginx:5403
      - ENABLE_PRICING=true
    depends_on:
      - beats-interaction-mongodb
      - beats-interaction-redis
      - kafka
      - space-nginx
    networks:
      - socialbeats-network
    ports:
      - "3002:3002"

  beats-service:
    restart: unless-stopped
    image: socialbeats/beats-upload:latest
    container_name: beats-service
    env_file:
      - ./.env
    environment:
      - MONGOADMIN=
      - MONGOPASS=
      - MONGOURL=mongodb://beats-upload-mongodb:27017/microservice-beats-upload
      - MONGOTESTURL=mongodb://beats-upload-mongodb:27017/microservice-beats-upload_test
      - NODE_ENV=development
      - JWT_SECRET=secret
      - PORT=3005
      - LOG_LEVEL=silly
      - API_TITLE="Beats Microservice API"
      - API_DESCRIPTION="This is an OAS description of beats Microservice REST API"
      - JWT_ACCESS_EXPIRY=15m
      - JWT_REFRESH_EXPIRY=7
      - KAFKA_CONNECTION_MAX_RETRIES=10
      - KAFKA_CONNECTION_RETRY_DELAY=3000
      - KAFKA_COOLDOWN=30000
      - KAFKA_BROKER=kafka:9092
      - ENABLE_KAFKA=true
      - CLOUDFRONT_URL_EXPIRATION=3600
      - TOOBUSY_MAX_LAG=100
      - S3_MAX_CONCURRENT=5
      - S3_MIN_TIME=0
    depends_on:
      - beats-upload-mongodb
      - kafka
    networks:
      - socialbeats-network
    ports:
      - "3005:3005"

  analytics-service:
    image: socialbeats/analytics-and-dashboards:latest
    command: uvicorn main:app --host 0.0.0.0 --port 3003 --reload
    container_name: analytics-service
    env_file:
      - ./.env
    ports:
      - "3003:3003"
    environment:
      - MONGODB_URL=mongodb://analytics-mongodb:27017
      - MONGODB_DB_NAME=analytics_db
      - REDIS_URL=redis://analytics-redis:6379
      - ENVIRONMENT=development
      - DEBUG=true
      - LOG_LEVEL=INFO
      - TEMP_AUDIO_DIR=temp_audio
      - MAX_UPLOAD_SIZE=104857600
      - BEATS_SERVICE_URL=http://beats-service:3005
      - APP_NAME="FastAPI MongoDB Template"
      - APP_VERSION="1.0.0"
      - APP_DESCRIPTION="A production-ready FastAPI + MongoDB template"
      - HOST="0.0.0.0"
      - PORT=3003
      - MONGODB_MAX_CONNECTIONS=10
      - MONGODB_MIN_CONNECTIONS=1
      - CORS_ORIGINS=["http://api-gateway:3000","http://analytics-service:3003"]
      - CORS_ALLOW_CREDENTIALS=true
      - CORS_ALLOW_METHODS=["*"]
      - CORS_ALLOW_HEADERS=["*"]
      - LOG_FORMAT="json"
      - JWT_SECRET="secret"
      - KAFKA_BROKER=kafka:9092
      - ENABLE_KAFKA=true
      - KAFKA_CONNECTION_MAX_RETRIES=10
      - KAFKA_CONNECTION_RETRY_DELAY=3000
      - KAFKA_COOLDOWN=30000
      - ENABLE_PRICING=true
    depends_on:
      analytics-mongodb:
        condition: service_healthy
      analytics-redis:
        condition: service_healthy
      kafka:
        condition: service_started
    networks:
      - socialbeats-network
    restart: unless-stopped
    volumes:
      - analytics-audio-temp:/app/temp_audio

  social-service:
    image: socialbeats/social:latest
    container_name: social-service
    environment:
      - MONGOADMIN=
      - MONGOPASS=
      - MONGOURL=mongodb://social-mongodb:27017/microservice-social
      - MONGOTESTURL=mongodb://social-mongodb:27017/microservice-social_test
      - NODE_ENV=development
      - JWT_SECRET=secret
      - PORT=3004
      - LOG_LEVEL=silly
      - API_TITLE="Social microservice API"
      - API_DESCRIPTION="This is an OAS description of this social microservice REST API"
      - ENABLE_KAFKA=true
      - KAFKA_BROKER=kafka:9092
      - KAFKA_CONNECTION_MAX_RETRIES=10
      - KAFKA_CONNECTION_RETRY_DELAY=3000
      - KAFKA_COOLDOWN=30000
    depends_on:
      - social-mongodb
      - kafka
    networks:
      - socialbeats-network
    ports:
      - "3004:3004"

  payments-and-suscription:
    image: socialbeats/payments-and-suscriptions:latest
    container_name: payments-and-suscription
    restart: unless-stopped
    env_file:
      - ./.env
    environment:
      - MONGOADMIN=
      - MONGOPASS=
      - MONGOURL=mongodb://payments-and-suscription-mongodb:27017/payments-and-subscriptions
      - MONGOTESTURL=mongodb://payments-and-suscription-mongodb:27017/payments-and-subscriptions_test
      - NODE_ENV=development
      - PORT=3006
      - LOG_LEVEL=info
      - JWT_SECRET=secret
      - API_TITLE="Payments and Subscriptions API"
      - API_DESCRIPTION="This is the Payments and Subscriptions microservice API for SocialBeats"
      - SPACE_URL=http://space-nginx:5403
      - FRONTEND_URL=http://localhost:5173
      - ENABLE_KAFKA=true
      - KAFKA_BROKER=kafka:9092
      - KAFKA_CONNECTION_MAX_RETRIES=10
      - KAFKA_CONNECTION_RETRY_DELAY=5000
      - KAFKA_COOLDOWN=30000
      - SPACE_SERVICE_NAME=socialbeats
      - SPACE_SERVICE_VERSION=1.1
    depends_on:
      - payments-and-suscription-mongodb
      - kafka
    networks:
      - socialbeats-network
    ports:
      - "3006:3006"

  # ======= SPACE STUFF =======
  space-mongodb:
    image: mongo:7.0.16
    container_name: space-mongodb
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: 4dm1n
      MONGO_INITDB_DATABASE: space_db
      DATABASE_NAME: space_db
      DATABASE_USERNAME: mongoUser
      DATABASE_PASSWORD: mongoPassword
    volumes:
      - 'space-mongodb:/data/db'
      - './scripts/init-space-mongo.sh:/docker-entrypoint-initdb.d/init-mongo.sh'
    ports:
      - "27022:27017"
    networks:
      - socialbeats-network
    restart: unless-stopped

  space-redis:
    image: redis:7.4.2
    container_name: space-redis
    healthcheck:
      test: [ "CMD", "redis-cli", "--raw", "incr", "ping" ]
      interval: 5s
      timeout: 5s
      retries: 3
      start_period: 5s
    restart: always
    volumes:
      - 'space-redis-data:/data'
    ports:
      - "6383:6379"
    networks:
      - socialbeats-network

  space-server:
    restart: always
    container_name: space-server
    image: socialbeats/space-server:1.0.1
    environment:
      ENVIRONMENT: production
      MONGO_URI: mongodb://mongoUser:mongoPassword@space-mongodb:27017/space_db
      REDIS_URL: redis://space-redis:6379
      JWT_SECRET: secret
      JWT_SALT: wgv~eb6v=VWwC9GIG1q6rZ]J.tUM(M
      JWT_EXPIRATION: 1d
    volumes:
      - 'space-statics:/usr/src/server/public'
    depends_on:
      - space-mongodb
      - space-redis
    networks:
      - socialbeats-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/v1/healthcheck"]
      interval: 1m30s
      timeout: 30s
      retries: 5
      start_period: 30s
  space-client:
    container_name: space-client
    image: socialbeats/space-client:1.0.1
    depends_on:
      - space-server
    networks:
      - socialbeats-network
    restart: unless-stopped

  space-nginx:
    restart: always
    container_name: space-nginx
    image: socialbeats/space-nginx:1.0.0
    ports:
      - 5403:5403
    depends_on:
      - space-server
      - space-client
    networks:
      - socialbeats-network

  # ======= KAFKA STUFF =======
  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    container_name: zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"
    networks:
      - socialbeats-network

  kafka:
    image: confluentinc/cp-kafka:7.5.0
    container_name: kafka
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
    networks:
      - socialbeats-network

  # ======= REDIS DATABASES =======
  user-auth-redis:
    restart: unless-stopped
    image: redis:7-alpine
    container_name: user-auth-redis
    networks:
      - socialbeats-network
    ports:
      - "6380:6379"
    volumes:
      - user-auth-redis-data:/data

  beats-interaction-redis:
    restart: unless-stopped
    image: redis:7-alpine
    container_name: beats-interaction-redis
    networks:
      - socialbeats-network
    ports:
      - "6381:6379"
    volumes:
      - beats-interaction-redis-data:/data

  api-gateway-redis:
    image: redis:7-alpine
    container_name: api-gateway-redis
    ports:
      - "6379:6379"
    volumes:
      - api-gateway-redis-data:/data
    networks:
      - socialbeats-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3
    command: redis-server --appendonly yes

  analytics-redis:
    image: redis:7-alpine
    container_name: analytics-redis
    ports:
      - "6382:6379"
    networks:
      - socialbeats-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 5s
    volumes:
      - analytics-redis-data:/data

  # ======= MONGO DATABASES =======
  user-auth-mongodb:
    restart: unless-stopped
    image: mongo:7.0
    container_name: user-auth-mongodb
    environment:
      - MONGO_INITDB_ROOT_USERNAME=
      - MONGO_INITDB_ROOT_PASSWORD=
    networks:
      - socialbeats-network
    ports:
      - "27017:27017"
    volumes:
      - user-auth-mongo-data:/data/db

  beats-interaction-mongodb:
    restart: unless-stopped
    image: mongo:7.0
    container_name: beats-interaction-mongodb
    environment:
      - MONGO_INITDB_ROOT_USERNAME=
      - MONGO_INITDB_ROOT_PASSWORD=
    networks:
      - socialbeats-network
    ports:
      - "27018:27017"
    volumes:
      - beats-interaction-mongo-data:/data/db

  beats-upload-mongodb:
    restart: unless-stopped
    image: mongo:7.0
    container_name: beats-upload-mongodb
    environment:
      - MONGO_INITDB_ROOT_USERNAME=
      - MONGO_INITDB_ROOT_PASSWORD=
    networks:
      - socialbeats-network
    ports:
      - "27020:27017"
    volumes:
      - beats-upload-mongo-data:/data/db

  analytics-mongodb:
    image: mongo:7.0
    container_name: analytics-mongodb
    ports:
      - "27019:27017"
    environment:
      - MONGO_INITDB_DATABASE=fastapi_template
    volumes:
      - analytics-mongodb-data:/data/db
      - analytics-mongodb-config:/data/configdb
    networks:
      - socialbeats-network
    restart: unless-stopped
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  analytics-mongo-express:
    image: mongo-express:latest
    container_name: analytics-mongo-express
    ports:
      - "8081:8081"
    environment:
      - ME_CONFIG_MONGODB_URL=mongodb://analytics-mongodb:27017
      - ME_CONFIG_BASICAUTH_USERNAME=admin
      - ME_CONFIG_BASICAUTH_PASSWORD=admin123
    depends_on:
      - analytics-mongodb
    networks:
      - socialbeats-network
    restart: unless-stopped
    profiles:
      - dev

  social-mongodb:
    restart: unless-stopped
    image: mongo:7.0
    container_name: social-mongodb
    environment:
      - MONGO_INITDB_ROOT_USERNAME=
      - MONGO_INITDB_ROOT_PASSWORD=
    networks:
      - socialbeats-network
    ports:
      - "27021:27017"
    volumes:
      - social-mongo-data:/data/db

  payments-and-suscription-mongodb:
    image: mongo:7.0
    container_name: payments-and-suscription-mongodb
    restart: unless-stopped
    environment:
      - MONGO_INITDB_ROOT_USERNAME=
      - MONGO_INITDB_ROOT_PASSWORD=
    volumes:
      - payments-and-suscription-mongo-data:/data/db
    networks:
      - socialbeats-network
    ports:
      - "27023:27017"

networks:
  socialbeats-network:
    driver: bridge

volumes:
  analytics-audio-temp:
  analytics-redis-data:
  api-gateway-redis-data:
  user-auth-redis-data:
  beats-interaction-mongo-data:
  beats-interaction-redis-data:
  user-auth-mongo-data:
  beats-upload-mongo-data:
  analytics-mongodb-data:
  analytics-mongodb-config:
  social-mongo-data:
  payments-and-suscription-mongo-data:
  space-mongodb:
  space-statics:
  space-redis-data: